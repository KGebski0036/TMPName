<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcard Quiz from ZIP</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .hidden {
      display: none;
    }

    .flashcard {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }

    .question {
      font-size: 1.2em;
    }

    .option {
      display: block;
      margin: 10px 0;
    }

    .correct {
      color: green;
    }

    .incorrect {
      color: red;
    }

    .score {
      font-size: 1.2em;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>Flashcard Quiz from ZIP Archive</h1>
  <input type="file" id="fileInput" accept=".zip" />

  <div id="flashcard" class="flashcard hidden">
    <div id="question" class="question"></div>
    <div id="options"></div>
    <div id="feedback" class="hidden"></div>
    <button id="nextButton" class="hidden">Next Question</button>
  </div>

  <div id="scoreboard" class="hidden">
    <div class="score"></div>
    <button id="restartButton">Restart Quiz</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script>
    let questions = [];
    let currentQuestionIndex = 0;
    let correctAnswerIndex = -1;
    let score = 0;
    let startTime = 0;
    let totalQuestions = 0;
    let usedQuestions = [];

    <!-- console.log("helo"); -->
    document
      .getElementById("fileInput")
      .addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (file && file.name.endsWith(".zip")) {
          readZipFile(file);
        } else {
          alert("Please upload a valid ZIP file.");
        }
      });

    function readZipFile(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const arrayBuffer = e.target.result;
        JSZip.loadAsync(arrayBuffer).then(function (zip) {
          loadQuestions(zip);
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function loadQuestions(zip) {
      questions = [];
      usedQuestions = [];

      zip.forEach(function (relativePath, zipEntry) {
        if (relativePath.endsWith(".txt")) {
          zipEntry.async("text").then(function (content) {
            const questionObj = parseQuestionFile(zipEntry.name, content);
            questions.push(questionObj);
            console.log(questionObj);
            totalQuestions = questions.length;
            if (questions.length === totalQuestions) {
              startQuiz();
            }
          });
        }
      });
    }

    function parseQuestionFile(fileName, content) {
      const correctAnswerIndex = parseInt(content.split("\n")[0].search("1")); // Last character is the correct index (1-based)

      const lines = content.split("\n");
      let questionText = "";
      const options = [];

      lines.forEach((line) => {
        line = line.trim();
        if (/^\d+\.\s/.test(line)) {
          questionText = line; // Question line
        } else if (/^[a-d]\)\s/.test(line)) {
          options.push(line); // Answer option line
        }
      });

      return {
        question: questionText,
        options: options,
        correct: correctAnswerIndex,
      };
    }

    function startQuiz() {
      document.getElementById("flashcard").classList.remove("hidden");
      document.getElementById("scoreboard").classList.add("hidden");
      currentQuestionIndex = 0;
      score = 0;
      startTime = Date.now();
      showRandomQuestion();
    }

    function showRandomQuestion() {
      // Get a random question
      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * questions.length);
      } while (usedQuestions.includes(randomIndex));

      usedQuestions.push(randomIndex);
      const questionObj = questions[randomIndex];
      correctAnswerIndex = questionObj.correct;

      document.getElementById("question").textContent = questionObj.question;
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      questionObj.options.forEach((option, index) => {
        const button = document.createElement("button");
        button.textContent = option;
        button.className = "option";
        button.addEventListener("click", function () {
          checkAnswer(index + 1); // Answer is 1-based
        });
        optionsDiv.appendChild(button);
      });
    }

    function checkAnswer(selectedIndex) {
      const feedbackDiv = document.getElementById("feedback");
      feedbackDiv.classList.remove("hidden");

      if (selectedIndex === correctAnswerIndex) {
        score++;
        feedbackDiv.textContent = "Correct!";
        feedbackDiv.classList.add("correct");
        feedbackDiv.classList.remove("incorrect");
      } else {
        feedbackDiv.textContent = "Incorrect!";
        feedbackDiv.classList.add("incorrect");
        feedbackDiv.classList.remove("correct");
      }

      document.getElementById("nextButton").classList.remove("hidden");

      if (usedQuestions.length === totalQuestions) {
        endQuiz();
      } else {
        document
          .getElementById("nextButton")
          .addEventListener("click", function () {
            document.getElementById("nextButton").classList.add("hidden");
            feedbackDiv.classList.add("hidden");
            showRandomQuestion();
          });
      }
    }

    function endQuiz() {
      const totalTime = (Date.now() - startTime) / 1000;
      document.getElementById("flashcard").classList.add("hidden");
      document.getElementById("scoreboard").classList.remove("hidden");
      document.querySelector(".score").textContent =
        `Score: ${score}/${totalQuestions}, Time: ${totalTime.toFixed(
          2,
        )} seconds`;

      document
        .getElementById("restartButton")
        .addEventListener("click", function () {
          startQuiz();
        });
    }
  </script>
</body>

</html>
